<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Sherry Aerial Anniversary</title>
    <script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>
    <script src="https://cdn.jsdelivr.net/npm/canvas-confetti@1.5.1/dist/confetti.browser.min.js"></script>
    <link href="https://fonts.googleapis.com/css2?family=Bodoni+Moda:ital,wght@0,400;1,500&family=Noto+Sans+TC:wght@300;400;500&display=swap" rel="stylesheet">
    <style>
        :root { 
            --platinum: #b8b8b8; /* 鉑金深色 */
            --silver: #e5e4e2;   /* 鉑金淺色 */
            --bg: #f8f9fa;      /* 珍珠白背景 */
            --text-main: #2d2d2d; 
            --glass: rgba(255, 255, 255, 0.7); 
        }
        
        body { 
            font-family: 'Noto Sans TC', sans-serif; 
            background: linear-gradient(135deg, #fdfbfb 0%, #ebedee 100%); 
            color: var(--text-main); 
            display: flex; 
            justify-content: center; 
            align-items: center; 
            min-height: 100vh; 
            margin: 0; 
            overflow-x: hidden; 
        }
        
        .container { 
            background: var(--glass); 
            backdrop-filter: blur(20px); 
            -webkit-backdrop-filter: blur(20px); 
            padding: 3.5rem 1.5rem; 
            border-radius: 40px; 
            border: 1px solid rgba(255,255,255,0.8); 
            text-align: center; 
            width: 90%; 
            max-width: 380px; 
            box-shadow: 0 20px 50px rgba(0,0,0,0.05); 
        }
        
        .title-group { margin-bottom: 2.5rem; }
        h1 { 
            font-family: 'Bodoni Moda', serif; 
            font-size: 1.5rem; 
            color: var(--text-main); 
            margin: 0; 
            letter-spacing: 2px; 
            line-height: 1.3; 
            font-weight: 500;
        }
        h1 span { 
            display: block; 
            font-size: 2.1rem; 
            margin-top: 5px; 
            background: linear-gradient(to right, #666, #999);
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
        }
        
        .subtitle { 
            font-size: 0.85rem; 
            letter-spacing: 6px; 
            color: #888; 
            margin-top: 0.8rem; 
            font-weight: 400; 
        }
        
        .input-box { 
            width: 100%; 
            padding: 18px; 
            margin-bottom: 1.2rem; 
            border-radius: 20px; 
            border: 1px solid rgba(0,0,0,0.08); 
            background: rgba(255,255,255,0.8); 
            color: var(--text-main); 
            font-size: 0.95rem; 
            box-sizing: border-box; 
            text-align: center; 
            outline: none; 
            transition: 0.3s; 
        }
        .input-box:focus { border-color: var(--platinum); box-shadow: 0 0 15px rgba(0,0,0,0.03); }
        
        .btn { 
            background: linear-gradient(145deg, #333, #555); 
            color: #fff; 
            border: none; 
            padding: 20px; 
            border-radius: 20px; 
            width: 100%; 
            font-weight: 400; 
            font-size: 1.1rem; 
            cursor: pointer; 
            transition: 0.4s; 
            letter-spacing: 5px; 
            margin-top: 10px; 
            box-shadow: 0 10px 20px rgba(0,0,0,0.1);
        }
        .btn:hover { transform: translateY(-2px); box-shadow: 0 15px 30px rgba(0,0,0,0.15); }
        
        #slot { 
            font-family: 'Bodoni Moda', serif; 
            font-size: 6.5rem; 
            color: #333; 
            margin: 30px 0; 
            height: 120px; 
            display: flex; 
            align-items: center; 
            justify-content: center; 
            letter-spacing: -2px;
        }
        
        .prize-item { 
            background: #fff; 
            margin: 12px 0; 
            padding: 16px; 
            border-radius: 18px; 
            cursor: pointer; 
            display: flex; 
            justify-content: space-between; 
            align-items: center; 
            border: 1px solid rgba(0,0,0,0.05); 
            transition: 0.3s; 
            box-shadow: 0 4px 10px rgba(0,0,0,0.02);
        }
        .prize-item:hover { transform: scale(1.02); border-color: #666; box-shadow: 0 8px 20px rgba(0,0,0,0.05); }
        .prize-item span:first-child { font-size: 0.9rem; flex: 1; text-align: left; padding-right: 8px; color: #444; }
        .prize-item span:last-child { font-size: 0.7rem; color: #666; border: 1px solid #ddd; padding: 4px 10px; border-radius: 8px; flex-shrink: 0; }
        
        .notice-text { color: #888; font-size: 0.85rem; margin-bottom: 15px; display: block; }
        
        .swal2-popup { border-radius: 35px !important; }
    </style>
</head>
<body>
<div class="container">
    <div class="title-group">
        <h1>2026 Sherry Aerial Studio<span>Anniversary</span></h1>
        <div class="subtitle">抽獎小程式</div>
    </div>

    <div id="view-login">
        <select id="email-select" class="input-box">
            <option value="">讀取名單中...</option>
        </select>
        <input type="text" id="code" class="input-box" placeholder="輸入指定密碼">
        <button class="btn" id="main-btn" onclick="onStartDraw()">抽獎</button>
    </div>

    <div id="view-anim" style="display:none;">
        <div id="slot">?</div>
        <div class="subtitle" id="anim-text">抽獎中...</div>
    </div>
</div>

<script>
    // 此處保留所有原本的邏輯程式碼，完全不變
    const scriptURL = 'https://script.google.com/macros/s/AKfycbyzPTHSx9vU7ydw1UJyDbXSxUdl_bbxnALfzz-vuQdcgRScMzaLJJUV-ysmRKOiiHQR/exec';
    let userEmail = "", userCode = "";
    let cachedPrizes = [];

    window.onload = async () => {
        try {
            const resp = await fetch(scriptURL, { method: 'POST', body: JSON.stringify({ action: "getEmailList" }) });
            const res = await resp.json();
            const select = document.getElementById('email-select');
            select.innerHTML = '<option value="">請選擇您的OB帳號(e-mail帳號)</option>';
            res.emails.forEach(e => select.innerHTML += `<option value="${e}">${e}</option>`);
        } catch(e) { 
            document.getElementById('email-select').innerHTML = '<option value="">連線錯誤，請刷新頁面</option>';
        }
    };

    async function onStartDraw() {
        userEmail = document.getElementById('email-select').value;
        userCode = document.getElementById('code').value.trim();
        if(!userEmail || !userCode) {
            Swal.fire({ text: '請完整填寫帳號與密碼', background: '#fff', color: '#333', confirmButtonColor: '#333' });
            return;
        }
        document.getElementById('main-btn').innerText = "確認中...";
        try {
            const resp = await fetch(scriptURL, { method: 'POST', body: JSON.stringify({ action: "verifyAndDraw", email: userEmail, code: userCode }) });
            const res = await resp.json();
            if(!res.success) {
                Swal.fire({ text: res.msg, background: '#fff', color: '#333', confirmButtonColor: '#333' });
                document.getElementById('main-btn').innerText = "抽獎";
                return;
            }
            cachedPrizes = res.prizes;
            document.getElementById('view-login').style.display = 'none';
            document.getElementById('view-anim').style.display = 'block';
            let count = 0;
            const itv = setInterval(() => {
                document.getElementById('slot').innerText = ['S','A','B','C','D','E','F'][Math.floor(Math.random()*7)];
                if(++count > 35) {
                    clearInterval(itv);
                    document.getElementById('slot').innerText = res.rank;
                    confetti({ particleCount: 100, spread: 70, origin: { y: 0.6 }, colors: ['#C0C0C0', '#E5E4E2', '#ffffff'] });
                    showPrizes(res.rank, cachedPrizes);
                }
            }, 80);
        } catch(e) {
            Swal.fire({ text: '連線超時', background: '#fff', color: '#333' });
            document.getElementById('main-btn').innerText = "抽獎";
        }
    }

    function showPrizes(rank, prizes) {
        let html = '<span class="notice-text">請選擇一個獎項，送出後即無法更換</span>';
        html += '<div style="max-height:350px; overflow-y:auto; padding-right:5px;">';
        prizes.forEach(p => {
            html += `<div class="prize-item" onclick="confirmPick('${rank}','${p}')"><span>${p}</span><span>選取</span></div>`;
        });
        Swal.fire({ 
            title: `RANK ${rank}`, 
            html: html + '</div>', 
            showConfirmButton: false, 
            allowOutsideClick: false, 
            allowEscapeKey: false,
            background: '#fff', 
            color: '#333',
            footer: '<span style="color:#999; font-size:11px;">※ 關閉頁面將導致無法領獎，請務必完成選取</span>'
        });
    }

    function confirmPick(rank, pName) {
        Swal.fire({
            title: '確認選擇',
            text: `確定選擇「${pName}」嗎？`,
            icon: 'question',
            showCancelButton: true,
            confirmButtonColor: '#333',
            cancelButtonColor: '#999',
            confirmButtonText: '確定',
            cancelButtonText: '返回',
            background: '#fff',
            color: '#333'
        }).then((result) => {
            if (result.isConfirmed) {
                onPick(rank, pName);
            } else if (result.dismiss === Swal.DismissReason.cancel) {
                showPrizes(rank, cachedPrizes);
            }
        });
    }

    async function onPick(rank, pName) {
        Swal.fire({ title: '紀錄中...', background: '#fff', color: '#333', didOpen: () => Swal.showLoading() });
        try {
            const resp = await fetch(scriptURL, { method: 'POST', body: JSON.stringify({ action: "confirmSelection", email: userEmail, code: userCode, rank: rank, prizeName: pName }) });
            const res = await resp.json();
            if(res.success) {
                const end = Date.now() + 2 * 1000;
                const colors = ['#C0C0C0', '#ffffff', '#E5E4E2'];
                (function frame() {
                    confetti({ particleCount: 3, angle: 60, spread: 55, origin: { x: 0 }, colors: colors });
                    confetti({ particleCount: 3, angle: 120, spread: 55, origin: { x: 1 }, colors: colors });
                    if (Date.now() < end) { requestAnimationFrame(frame); }
                }());
                Swal.fire({ 
                    icon: 'success',
                    iconColor: '#C0C0C0',
                    title: '恭喜中獎', 
                    text: `獎項：${pName}`, 
                    background: '#fff', 
                    color: '#333', 
                    confirmButtonColor: '#333',
                    confirmButtonText: '完成'
                }).then(() => location.reload());
            }
        } catch(e) {
            Swal.fire({ text: '紀錄失敗', background: '#fff', color: '#333' });
        }
    }
</script>
</body>
</html>
